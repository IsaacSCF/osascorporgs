<!DOCTYPE html>
<html lang='pt-BR'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Sistema de Gestão de Orgs</title>
    <script src='https://unpkg.com/react@18/umd/react.development.js'></script>
    <script src='https://unpkg.com/react-dom@18/umd/react-dom.development.js'></script>
    <script src='https://unpkg.com/@babel/standalone/babel.min.js'></script>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css' rel='stylesheet'>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css' rel='stylesheet'>
    <style>
        body { background-color: #f8f9fa; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
        .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border: none; }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); border: none; }
        .table { border-radius: 10px; overflow: hidden; }
        .badge-legal { background-color: #28a745; }
        .badge-ilegal { background-color: #dc3545; }
        .stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .modal-content { border-radius: 15px; }
        .form-control:focus { border-color: #667eea; box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25); }
        .loading { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .alert { border: none; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .fade { transition: opacity 0.3s ease-in-out; }
        .alert-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        .btn-close { filter: brightness(0) invert(1); }
    </style>
</head>
<body>
    <div id='root'>
        <div class='loading'>
            <div class='spinner'></div>
            <div style='margin-left: 20px; font-size: 18px; color: #667eea;'>Carregando Sistema de Gestão...</div>
        </div>
    </div>

    <script type='text/babel'>
        const { useState, useEffect } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [orgs, setOrgs] = useState([]);
            const [filteredOrgs, setFilteredOrgs] = useState([]);
            const [auditLogs, setAuditLogs] = useState([]);
            const [loading, setLoading] = useState(false);
            const [showModal, setShowModal] = useState(false);
            const [editingOrg, setEditingOrg] = useState(null);
            const [selectedOrgs, setSelectedOrgs] = useState([]);
            const [filterType, setFilterType] = useState('TODOS'); // TODOS, LEGAL, ILEGAL
            const [formData, setFormData] = useState({
                faccao: '', tipo: 'LEGAL', membros_ativos: '', tags_fabricacao: [
                    'Armas', 'Drogas', 'Veículos', 'Dinheiro', 'Documentos', 'Joias', 'Eletrônicos', 'Roupas', 'Comida', 'Bebidas'
                ], contato: '', discord_lider: '', data_entrega: '', ativo: true, entregue: false
            });

            // Auth state
            const [loginData, setLoginData] = useState({ username: '', password: '' });
            const [rememberMe, setRememberMe] = useState(false);
            const [showAuth, setShowAuth] = useState(true);
            const [authMode, setAuthMode] = useState('welcome'); // 'welcome', 'login', 'register'
            const [appLoading, setAppLoading] = useState(true);
            const [loginAttempts, setLoginAttempts] = useState(0);
            const [isBlocked, setIsBlocked] = useState(false);
            const [blockTimeLeft, setBlockTimeLeft] = useState(0);

            // Register state
            const [registerData, setRegisterData] = useState({
                username: '',
                email: '',
                password: '',
                confirmPassword: ''
            });

            // Admin panel state
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [pendingUsers, setPendingUsers] = useState([]);
            const [allUsers, setAllUsers] = useState([]);
            const [userFilter, setUserFilter] = useState('');
            const [autoRefresh, setAutoRefresh] = useState(true);

            // Detect API base URL dynamically
            const getApiBase = () => {
                // Production: Vercel deployment
                if (window.location.hostname.includes('vercel.app') || 
                    window.location.hostname.includes('netlify.app') || 
                    window.location.hostname.includes('pages.dev')) {
                    // Production Railway backend URL
                    return 'https://osascorp-production.up.railway.app';
                }
                
                // Development: Ngrok tunnels
                if (window.location.hostname.includes('ngrok')) {
                    return `${window.location.protocol}//${window.location.hostname}:8000`;
                }
                
                // Development: Local
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    return 'http://127.0.0.1:8000';
                }
                
                // Fallback
                return 'http://127.0.0.1:8000';
            };
            
            const API_BASE = getApiBase();

            // Helper function to show notifications
            const showNotification = (message, type = 'success', duration = 3000) => {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, duration);
            };

            useEffect(() => {
                // Simular carregamento inicial
                setTimeout(() => {
                    setAppLoading(false);
                const token = localStorage.getItem('token');
                    const remember = localStorage.getItem('rememberMe') === 'true';
                    if (token && (remember || Date.now() - parseInt(localStorage.getItem('loginTime') || '0') < 24 * 60 * 60 * 1000)) {
                        fetchUser(token);
                    } else {
                        setShowAuth(true);
                        setAuthMode('welcome');
                    }
                }, 1000);

                // Timer para bloqueio de login
                const timer = setInterval(() => {
                    if (blockTimeLeft > 0) {
                        setBlockTimeLeft(prev => prev - 1);
                    } else if (isBlocked) {
                        setIsBlocked(false);
                        setLoginAttempts(0);
                    }
                }, 1000);

                // Timer para auto-refresh
                const refreshTimer = setInterval(() => {
                    if (autoRefresh && user) {
                        const token = localStorage.getItem('token');
                        if (token) {
                            fetchOrgs(token);
                            fetchAuditLogs(token);
                            if (user.role === 'admin') {
                                fetchPendingUsers(token);
                                fetchAllUsers(token);
                            }
                        }
                    }
                }, 5000); // Atualiza a cada 5 segundos

                return () => {
                    clearInterval(timer);
                    clearInterval(refreshTimer);
                };
            }, [blockTimeLeft, isBlocked, autoRefresh, user]);

            const fetchUser = async (token) => {
                try {
                    const response = await fetch(`${API_BASE}/auth/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const userData = await response.json();
                        setUser(userData);
                        setShowAuth(false);
                        fetchOrgs(token);
                        fetchAuditLogs(token);

                        // Fetch admin data if user is admin
                        if (userData.role === 'admin') {
                            fetchPendingUsers(token);
                            fetchAllUsers(token);
                        }
                    } else {
                        localStorage.removeItem('token');
                        setShowAuth(true);
                        setAuthMode('welcome');
                    }
                } catch (error) {
                    console.error('Erro ao buscar usuário:', error);
                    setShowAuth(true);
                    setAuthMode('welcome');
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();

                if (isBlocked) {
                    showNotification(`Conta bloqueada. Tente novamente em ${Math.ceil(blockTimeLeft / 60)} minutos.`, 'danger', 5000);
                    return;
                }

                setLoading(true);
                try {
                    const response = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(loginData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        localStorage.setItem('token', data.access_token);
                        localStorage.setItem('rememberMe', rememberMe.toString());
                        localStorage.setItem('loginTime', Date.now().toString());
                        setLoginAttempts(0);
                        await fetchUser(data.access_token);
                    } else {
                        const newAttempts = loginAttempts + 1;
                        setLoginAttempts(newAttempts);

                        if (newAttempts >= 5) {
                            setIsBlocked(true);
                            setBlockTimeLeft(5 * 60); // 5 minutos
                            showNotification('Muitas tentativas falhadas. Conta bloqueada por 5 minutos.', 'danger', 5000);
                        } else {
                            showNotification(`Erro no login: ${data.detail || 'Credenciais inválidas'} (${newAttempts}/5 tentativas)`, 'danger', 5000);
                        }
                    }
                } catch (error) {
                    showNotification('Erro na conexão. Verifique se o backend está rodando.', 'danger', 5000);
                }
                setLoading(false);
            };

            const handleBackToWelcome = () => {
                setAuthMode('welcome');
            };

            const handleRegister = async (e) => {
                e.preventDefault();

                if (registerData.password !== registerData.confirmPassword) {
                    showNotification('As senhas não coincidem.', 'danger', 5000);
                    return;
                }

                if (registerData.password.length < 6) {
                    showNotification('A senha deve ter pelo menos 6 caracteres.', 'danger', 5000);
                    return;
                }

                setLoading(true);
                try {
                    const response = await fetch(`${API_BASE}/auth/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: registerData.username,
                            email: registerData.email,
                            password: registerData.password
                        })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showNotification('Registro realizado com sucesso! Aguarde aprovação do administrador.', 'success', 5000);
                        setAuthMode('welcome');
                        setRegisterData({
                            username: '',
                            email: '',
                            password: '',
                            confirmPassword: ''
                        });
                    } else {
                        showNotification(`Erro no registro: ${data.detail || 'Erro desconhecido'}`, 'danger', 5000);
                    }
                } catch (error) {
                    showNotification('Erro na conexão. Verifique se o backend está rodando.', 'danger', 5000);
                }
                setLoading(false);
            };

            const fetchOrgs = async (token) => {
                try {
                    const response = await fetch(`${API_BASE}/orgs/`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setOrgs(data);
                        applyFilter(data, filterType);
                    }
                } catch (error) {
                    console.error('Erro ao buscar orgs:', error);
                }
            };

            const applyFilter = (orgsData, type) => {
                let filtered = orgsData;
                if (type === 'LEGAL') {
                    filtered = orgsData.filter(org => org.tipo === 'LEGAL');
                } else if (type === 'ILEGAL') {
                    filtered = orgsData.filter(org => org.tipo === 'ILEGAL');
                }
                setFilteredOrgs(filtered);
            };

            const handleFilterChange = (type) => {
                setFilterType(type);
                applyFilter(orgs, type);
                setSelectedOrgs([]); // Clear selection when filtering
            };

            const fetchAuditLogs = async (token) => {
                try {
                    const response = await fetch(`${API_BASE}/orgs/audit/`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setAuditLogs(data.slice(-10)); // Últimas 10 ações
                    }
                } catch (error) {
                    console.error('Erro ao buscar logs:', error);
                }
            };

            const fetchPendingUsers = async (token) => {
                try {
                    const response = await fetch(`${API_BASE}/auth/pending`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setPendingUsers(data);
                    }
                } catch (error) {
                    console.error('Erro ao buscar usuários pendentes:', error);
                }
            };

            const fetchAllUsers = async (token) => {
                try {
                    const response = await fetch(`${API_BASE}/auth/?status_filter=${userFilter || ''}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setAllUsers(data);
                    }
                } catch (error) {
                    console.error('Erro ao buscar todos os usuários:', error);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                const token = localStorage.getItem('token');

                if (!token) {
                        showNotification('Sessão expirada. Faça login novamente.', 'danger', 5000);
                    setShowAuth(true);
                    setAuthMode('welcome');
                    setLoading(false);
                    return;
                }

                const url = editingOrg ? `${API_BASE}/orgs/${editingOrg.id}` : `${API_BASE}/orgs/`;
                const method = editingOrg ? 'PUT' : 'POST';

                // Prepare data for submission
                const submitData = {
                    ...formData,
                    membros_ativos: formData.membros_ativos ? parseInt(formData.membros_ativos) : null,
                    tags_fabricacao: formData.tags_fabricacao || []
                };

                try {
                    const response = await fetch(url, {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(submitData)
                    });

                    if (response.ok) {
                        const result = await response.json();

                        // Update local state immediately for instant UI feedback
                        if (editingOrg) {
                            // Update existing org in state
                            setOrgs(prevOrgs => prevOrgs.map(org =>
                                org.id === editingOrg.id ? result : org
                            ));
                            setFilteredOrgs(prevFiltered => prevFiltered.map(org =>
                                org.id === editingOrg.id ? result : org
                            ));
                        } else {
                            // Add new org to state
                            setOrgs(prevOrgs => [result, ...prevOrgs]);
                            setFilteredOrgs(prevFiltered => [result, ...prevFiltered]);
                        }

                        // Refresh audit logs in background (non-blocking)
                        fetchAuditLogs(token).catch(console.error);

                        setShowModal(true);
                        setEditingOrg(null);
                        setFormData({ faccao: '', tipo: 'LEGAL', membros_ativos: '', tags_fabricacao: [
                            'Armas', 'Drogas', 'Veículos', 'Dinheiro', 'Documentos', 'Joias', 'Eletrônicos', 'Roupas', 'Comida', 'Bebidas'
                        ], contato: '', discord_lider: '', data_entrega: '', ativo: true, entregue: false });

                        // Show success message briefly, then auto-hide
                        const successMsg = editingOrg ? 'Organização atualizada com sucesso!' : 'Organização criada com sucesso!';
                        showNotification(successMsg, 'success', 3000);
                    } else {
                        let errorMessage = 'Erro desconhecido';
                        try {
                            const error = await response.json();
                            if (typeof error.detail === 'string') {
                                errorMessage = error.detail;
                            } else if (error.detail) {
                                errorMessage = JSON.stringify(error.detail);
                            } else if (error.message) {
                                errorMessage = error.message;
                            } else {
                                errorMessage = `Erro ${response.status}`;
                            }
                        } catch {
                            errorMessage = `Erro ${response.status}: ${response.statusText}`;
                        }
                        showNotification('Erro ao salvar: ' + errorMessage, 'danger', 5000);
                    }
                } catch (error) {
                    console.error('Organização atualizada com sucesso!:', error);
                    showNotification('Organização atualizada com sucesso!', 'success', 3000);
                }
                setLoading(false);
            };

            const handleDelete = async (orgId) => {
                if (!window.confirm('Tem certeza que deseja excluir esta organização?')) return;

                setLoading(true);
                const token = localStorage.getItem('token');

                try {
                    const response = await fetch(`${API_BASE}/orgs/${orgId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        // Update local state immediately for instant UI feedback
                        setOrgs(prevOrgs => prevOrgs.filter(org => org.id !== orgId));
                        setFilteredOrgs(prevFiltered => prevFiltered.filter(org => org.id !== orgId));
                        setSelectedOrgs(selectedOrgs.filter(id => id !== orgId)); // Remove from selection

                        // Refresh audit logs in background (non-blocking)
                        fetchAuditLogs(token).catch(console.error);

                        // Show success message briefly
                        showNotification('Organização excluída com sucesso!', 'success', 3000);
                    } else {
                        showNotification('Erro ao excluir organização!', 'danger', 5000);
                    }
                } catch (error) {
                    showNotification('Erro na conexão ao excluir!', 'danger', 5000);
                }
                setLoading(false);
            };

            const handleBulkDelete = async () => {
                if (selectedOrgs.length === 0) {
                    showNotification('Selecione pelo menos uma organização para excluir.', 'warning', 5000);
                    return;
                }

                if (!window.confirm(`Tem certeza que deseja excluir ${selectedOrgs.length} organizações?`)) return;

                setLoading(true);
                const token = localStorage.getItem('token');
                let successCount = 0;
                let errorCount = 0;

                for (const orgId of selectedOrgs) {
                    try {
                        const response = await fetch(`${API_BASE}/orgs/${orgId}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        errorCount++;
                    }
                }

                if (successCount > 0) {
                    // Update local state immediately for instant UI feedback
                    setOrgs(prevOrgs => prevOrgs.filter(org => !selectedOrgs.includes(org.id)));
                    setFilteredOrgs(prevFiltered => prevFiltered.filter(org => !selectedOrgs.includes(org.id)));
                    setSelectedOrgs([]);

                    // Refresh audit logs in background (non-blocking)
                    fetchAuditLogs(token).catch(console.error);

                    // Show success message briefly
                    const message = `${successCount} organizações excluídas com sucesso!${errorCount > 0 ? ` ${errorCount} falharam.` : ''}`;
                    showNotification(message, 'success', 3000);
                } else {
                    showNotification('Erro ao excluir organizações!', 'danger', 5000);
                }
                setLoading(false);
            };

            const handleSelectOrg = (orgId) => {
                if (selectedOrgs.includes(orgId)) {
                    setSelectedOrgs(selectedOrgs.filter(id => id !== orgId));
                } else {
                    setSelectedOrgs([...selectedOrgs, orgId]);
                }
            };

            const handleSelectAll = () => {
                if (selectedOrgs.length === filteredOrgs.length) {
                    setSelectedOrgs([]);
                } else {
                    setSelectedOrgs(filteredOrgs.map(org => org.id));
                }
            };

            const handleEdit = (org) => {
                setEditingOrg(org);
                setFormData({
                    faccao: org.faccao,
                    tipo: org.tipo,
                    membros_ativos: org.membros_ativos || '',
                    tags_fabricacao: org.tags_fabricacao || [],
                    contato: org.contato || '',
                    discord_lider: org.discord_lider || '',
                    data_entrega: org.data_entrega || '',
                    ativo: org.ativo !== false,
                    entregue: org.entregue || false
                });
                setShowModal(true);
            };

            const handleLogout = () => {
                localStorage.removeItem('token');
                localStorage.removeItem('rememberMe');
                localStorage.removeItem('loginTime');
                setUser(null);
                setOrgs([]);
                setAuditLogs([]);
                setPendingUsers([]);
                setAllUsers([]);
                setShowAuth(true);
                setAuthMode('welcome');
                setShowAdminPanel(false);
                setLoginAttempts(0);
                setIsBlocked(false);
                setBlockTimeLeft(0);
            };

            const handleApproveUser = async (userId, approval) => {
                setLoading(true);
                const token = localStorage.getItem('token');

                try {
                    const response = await fetch(`${API_BASE}/auth/${userId}/approve`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(approval)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showNotification(`Usuário ${result.username} ${approval.status === 'aprovado' ? 'aprovado' : 'rejeitado'} com sucesso!`, 'success', 3000);

                        // Refresh data
                        await fetchPendingUsers(token);
                        await fetchAllUsers(token);
                    } else {
                        const error = await response.json();
                        showNotification('Erro: ' + (error.detail || 'Erro desconhecido'), 'danger', 5000);
                    }
                } catch (error) {
                    showNotification('Erro na conexão', 'danger', 5000);
                }
                setLoading(false);
            };

            const handleUpdateUser = async (userId, updates) => {
                setLoading(true);
                const token = localStorage.getItem('token');

                try {
                    const response = await fetch(`${API_BASE}/auth/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(updates)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showNotification('Usuário atualizado com sucesso!', 'success', 3000);

                        // Refresh data
                        await fetchAllUsers(token);
                    } else {
                        const error = await response.json();
                        showNotification('Erro: ' + (error.detail || 'Erro desconhecido'), 'danger', 5000);
                    }
                } catch (error) {
                    showNotification('Erro na conexão', 'danger', 5000);
                }
                setLoading(false);
            };

            const handleDeleteUser = async (userId) => {
                if (!confirm('Tem certeza que deseja excluir este usuário?')) return;

                setLoading(true);
                const token = localStorage.getItem('token');

                try {
                    const response = await fetch(`${API_BASE}/auth/${userId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        showNotification('Usuário excluído com sucesso!', 'success', 3000);

                        // Refresh data
                        await fetchAllUsers(token);
                    } else {
                        showNotification('Erro ao excluir usuário', 'danger', 5000);
                    }
                } catch (error) {
                    showNotification('Erro na conexão', 'danger', 5000);
                }
                setLoading(false);
            };

            const handleChangePassword = async (userId) => {
                const newPassword = prompt('Digite a nova senha (mínimo 6 caracteres):');
                if (!newPassword || newPassword.length < 6) {
                    alert('Senha deve ter pelo menos 6 caracteres.');
                    return;
                }

                setLoading(true);
                const token = localStorage.getItem('token');

                try {
                    const response = await fetch(`${API_BASE}/auth/${userId}/change-password`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(newPassword)
                    });

                    if (response.ok) {
                        showNotification('Senha alterada com sucesso!', 'success', 3000);
                    } else {
                        const error = await response.json();
                        showNotification('Erro: ' + (error.detail || 'Erro desconhecido'), 'danger', 5000);
                    }
                } catch (error) {
                    showNotification('Erro na conexão', 'danger', 5000);
                }
                setLoading(false);
            };

            const handleToggleBlockUser = async (userId, currentStatus) => {
                const action = currentStatus === 'suspenso' ? 'desbloquear' : 'bloquear';
                if (!confirm(`Tem certeza que deseja ${action} este usuário?`)) return;

                setLoading(true);
                const token = localStorage.getItem('token');
                const newStatus = currentStatus === 'suspenso' ? 'aprovado' : 'suspenso';

                try {
                    const response = await fetch(`${API_BASE}/auth/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (response.ok) {
                        showNotification(`Usuário ${action}do com sucesso!`, 'success', 3000);

                        // Refresh data
                        await fetchAllUsers(token);
                    } else {
                        const error = await response.json();
                        showNotification('Erro: ' + (error.detail || 'Erro desconhecido'), 'danger', 5000);
                    }
                } catch (error) {
                    showNotification('Erro na conexão', 'danger', 5000);
                }
                setLoading(false);
            };

            const handleImport = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const formDataUpload = new FormData();
                formDataUpload.append('file', file);

                setLoading(true);
                const token = localStorage.getItem('token');

                try {
                    const response = await fetch(`${API_BASE}/orgs/import`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formDataUpload
                    });

                    if (response.ok) {
                        const result = await response.json();

                        // Show success message briefly
                        showNotification(`Importado com sucesso: ${result.message}`, 'success', 5000);

                        // Refresh data in background (non-blocking)
                        await fetchOrgs(token);
                        await fetchAuditLogs(token);
                      } else {
                        const error = await response.json();
                        showNotification('Erro no import: ' + (error.detail || 'Erro desconhecido'), 'danger', 5000);
                    }
                } catch (error) {
                    showNotification('Erro na conexão durante import', 'danger', 5000);
                }
                setLoading(false);
                e.target.value = ''; // Reset file input
            };

            const totalLegal = orgs.filter(org => org.tipo === 'LEGAL').length;
            const totalIlegal = orgs.filter(org => org.tipo === 'ILEGAL').length;
            const totalMembros = orgs.reduce((sum, org) => sum + (org.membros_ativos || 0), 0);

            if (appLoading) {
                return (
                    <div className='loading'>
                        <div className='spinner'></div>
                        <div style={{marginLeft: '20px', fontSize: '18px', color: '#667eea'}}>
                            Carregando Sistema de Gestão...
                        </div>
                    </div>
                );
            }

            if (showAuth && authMode === 'welcome') {
                return (
                    <div className='container mt-5'>
                        <div className='row justify-content-center'>
                            <div className='col-md-8'>
                                <div className='card p-5 shadow-lg text-center'>
                                    <div className='mb-4'>
                                        <i className='fas fa-shield-alt fa-4x text-primary mb-4'></i>
                                        <h1 className='fw-bold mb-3'>Sistema de Gestão de Orgs</h1>
                                        <p className='text-muted fs-5 mb-4'>Gerencie organizações de forma eficiente e segura</p>
                                    </div>

                                    <div className='row g-3'>
                                        <div className='col-md-6'>
                                            <button
                                                className='btn btn-primary btn-lg w-100 py-3 fw-bold'
                                                onClick={() => setAuthMode('login')}
                                            >
                                                <i className='fas fa-sign-in-alt me-2'></i>
                                                Entrar
                                            </button>
                                        </div>
                                        <div className='col-md-6'>
                                            <button
                                                className='btn btn-success btn-lg w-100 py-3 fw-bold'
                                                onClick={() => setAuthMode('register')}
                                            >
                                                <i className='fas fa-user-plus me-2'></i>
                                                Registrar-se
                                            </button>
                                        </div>
                                    </div>

                                    <hr className='my-4' />

                                    <div className='row text-center'>
                                        <div className='col-4'>
                                            <i className='fas fa-building fa-2x text-primary mb-2'></i>
                                            <p className='small mb-0'>Gestão de Orgs</p>
                                        </div>
                                        <div className='col-4'>
                                            <i className='fas fa-users fa-2x text-success mb-2'></i>
                                            <p className='small mb-0'>Controle de Membros</p>
                                        </div>
                                        <div className='col-4'>
                                            <i className='fas fa-shield-alt fa-2x text-warning mb-2'></i>
                                            <p className='small mb-0'>Sistema Seguro</p>
                                        </div>
                                    </div>

                                    <div className='mt-4'>
                                        <small className='text-muted'>
                                            <i className='fas fa-info-circle me-1'></i>
                                            Osasco RolePlay - Sistema de Gestão de Organizações
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (showAuth && authMode === 'login') {
                return (
                    <div className='container mt-5'>
                        <div className='row justify-content-center'>
                            <div className='col-md-6'>
                                <div className='card p-4 shadow-lg'>
                                    <div className='text-center mb-4'>
                                        <i className='fas fa-shield-alt fa-3x text-primary mb-3'></i>
                                        <h2 className='fw-bold'>Sistema de Gestão de Orgs</h2>
                                        <p className='text-muted'>Entre com suas credenciais</p>
                                    </div>

                                    {isBlocked && (
                                        <div className='alert alert-danger text-center mb-3'>
                                            <i className='fas fa-lock me-2'></i>
                                            Conta bloqueada por tentativas excessivas.
                                            <br />
                                            <strong>Tempo restante: {Math.floor(blockTimeLeft / 60)}:{(blockTimeLeft % 60).toString().padStart(2, '0')}</strong>
                                        </div>
                                    )}

                                    <form onSubmit={handleLogin}>
                                        <div className='mb-3'>
                                            <label className='form-label fw-semibold'>
                                                <i className='fas fa-user me-2'></i>Usuário
                                            </label>
                                            <input
                                                type='text'
                                                className='form-control form-control-lg'
                                                value={loginData.username}
                                                onChange={(e) => setLoginData({...loginData, username: e.target.value})}
                                                required
                                                disabled={isBlocked}
                                                placeholder='Digite seu usuário'
                                            />
                                        </div>
                                        <div className='mb-3'>
                                            <label className='form-label fw-semibold'>
                                                <i className='fas fa-lock me-2'></i>Senha
                                            </label>
                                            <input
                                                type='password'
                                                className='form-control form-control-lg'
                                                value={loginData.password}
                                                onChange={(e) => setLoginData({...loginData, password: e.target.value})}
                                                required
                                                disabled={isBlocked}
                                                placeholder='Digite sua senha'
                                            />
                                        </div>
                                        <div className='mb-3 form-check'>
                                            <input
                                                type='checkbox'
                                                className='form-check-input'
                                                id='rememberMe'
                                                checked={rememberMe}
                                                onChange={(e) => setRememberMe(e.target.checked)}
                                                disabled={isBlocked}
                                            />
                                            <label className='form-check-label' htmlFor='rememberMe'>
                                                <i className='fas fa-clock me-1'></i>Lembrar-me por 30 dias
                                            </label>
                                        </div>
                                        <button
                                            type='submit'
                                            className='btn btn-primary btn-lg w-100 fw-bold'
                                            disabled={loading || isBlocked}
                                        >
                                            {loading ? (
                                                <>
                                                    <span className='spinner-border spinner-border-sm me-2' role='status'></span>
                                                    Entrando...
                                                </>
                                            ) : (
                                                <>
                                                    <i className='fas fa-sign-in-alt me-2'></i>
                                                    Entrar
                                                </>
                                            )}
                                        </button>
                                    </form>

                                    <div className='text-center mt-3'>
                                        <button
                                            className='btn btn-link text-decoration-none'
                                            onClick={() => setAuthMode('register')}
                                        >
                                            <i className='fas fa-user-plus me-1'></i>
                                            Não tem conta? Registre-se
                                        </button>
                                    </div>

                                    <div className='text-center mt-4'>
                                        <div className='row'>
                                            <div className='col-6'>
                                                <small className='text-muted'>
                                                    <i className='fas fa-info-circle me-1'></i>
                                                    Osasco RolePlay
                                                </small>
                                            </div>
                                            <div className='col-6'>
                                                <small className='text-muted'>
                                                    <i className='fas fa-shield-alt me-1'></i>
                                                    Tentativas: {loginAttempts}/5
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <hr className='my-4' />

                                    <div className='text-center'>
                                        <small className='text-muted'>
                                            <i className='fas fa-lock me-1'></i>
                                            Sistema seguro com criptografia avançada
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (showAuth && authMode === 'register') {
                return (
                    <div className='container mt-5'>
                        <div className='row justify-content-center'>
                            <div className='col-md-6'>
                                <div className='card p-4 shadow-lg'>
                                    <div className='text-center mb-4'>
                                        <i className='fas fa-user-plus fa-3x text-success mb-3'></i>
                                        <h2 className='fw-bold'>Registro de Usuário</h2>
                                        <p className='text-muted'>Crie sua conta para acessar o sistema</p>
                                    </div>

                                    <form onSubmit={handleRegister}>
                                        <div className='mb-3'>
                                            <label className='form-label fw-semibold'>
                                                <i className='fas fa-user me-2'></i>Usuário
                                            </label>
                                            <input
                                                type='text'
                                                className='form-control form-control-lg'
                                                value={registerData.username}
                                                onChange={(e) => setRegisterData({...registerData, username: e.target.value})}
                                                required
                                                placeholder='Digite seu usuário'
                                                minLength='3'
                                                maxLength='50'
                                            />
                                            <small className='text-muted'>3-50 caracteres, apenas letras, números e _</small>
                                        </div>
                                        <div className='mb-3'>
                                            <label className='form-label fw-semibold'>
                                                <i className='fas fa-envelope me-2'></i>Email
                                            </label>
                                            <input
                                                type='email'
                                                className='form-control form-control-lg'
                                                value={registerData.email}
                                                onChange={(e) => setRegisterData({...registerData, email: e.target.value})}
                                                required
                                                placeholder='Digite seu email'
                                            />
                                        </div>
                                        <div className='mb-3'>
                                            <label className='form-label fw-semibold'>
                                                <i className='fas fa-lock me-2'></i>Senha
                                            </label>
                                            <input
                                                type='password'
                                                className='form-control form-control-lg'
                                                value={registerData.password}
                                                onChange={(e) => setRegisterData({...registerData, password: e.target.value})}
                                                required
                                                placeholder='Digite sua senha'
                                                minLength='6'
                                            />
                                            <small className='text-muted'>Mínimo 6 caracteres</small>
                                        </div>
                                        <div className='mb-3'>
                                            <label className='form-label fw-semibold'>
                                                <i className='fas fa-lock me-2'></i>Confirmar Senha
                                            </label>
                                            <input
                                                type='password'
                                                className='form-control form-control-lg'
                                                value={registerData.confirmPassword}
                                                onChange={(e) => setRegisterData({...registerData, confirmPassword: e.target.value})}
                                                required
                                                placeholder='Confirme sua senha'
                                            />
                                        </div>
                                        <button
                                            type='submit'
                                            className='btn btn-success btn-lg w-100 fw-bold'
                                            disabled={loading}
                                        >
                                            {loading ? (
                                                <>
                                                    <span className='spinner-border spinner-border-sm me-2' role='status'></span>
                                                    Registrando...
                                                </>
                                            ) : (
                                                <>
                                                    <i className='fas fa-user-plus me-2'></i>
                                                    Registrar
                                                </>
                                            )}
                                        </button>
                                    </form>

                                    <div className='text-center mt-3'>
                                        <button
                                            className='btn btn-link text-decoration-none'
                                            onClick={handleBackToWelcome}
                                        >
                                            <i className='fas fa-arrow-left me-1'></i>
                                            Voltar ao Início
                                        </button>
                                    </div>

                                    <hr className='my-4' />

                                    <div className='text-center'>
                                        <small className='text-muted'>
                                            <i className='fas fa-info-circle me-1'></i>
                                            Após o registro, aguarde aprovação do administrador
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div>
                    <nav className='navbar navbar-expand-lg navbar-dark mb-4'>
                        <div className='container'>
                            <a className='navbar-brand' href='#'>
                                <i className='fas fa-building me-2'></i>
                                Sistema de Gestão de Orgs
                            </a>
                            <div className='navbar-nav ms-auto'>
                                <span className='navbar-text me-3'>
                                    <i className='fas fa-user me-1'></i>
                                    {user?.username} ({user?.role})
                                </span>
                                <div className='form-check form-switch me-3'>
                                    <input
                                        className='form-check-input'
                                        type='checkbox'
                                        id='autoRefreshToggle'
                                        checked={autoRefresh}
                                        onChange={(e) => setAutoRefresh(e.target.checked)}
                                    />
                                    <label className='form-check-label text-light' htmlFor='autoRefreshToggle'>
                                        <small>Auto-refresh (5s)</small>
                                    </label>
                                </div>
                                {user?.role === 'admin' && (
                                    <button
                                        className='btn btn-outline-warning btn-sm me-2'
                                        onClick={() => setShowAdminPanel(!showAdminPanel)}
                                    >
                                        <i className='fas fa-cog me-1'></i>
                                        Admin
                                    </button>
                                )}
                                <button className='btn btn-outline-light btn-sm' onClick={handleLogout}>
                                    <i className='fas fa-sign-out-alt me-1'></i>
                                    Sair
                                </button>
                            </div>
                        </div>
                    </nav>

                    <div className='container'>
                        <div className='row mb-4'>
                            <div className='col-md-3'>
                                <div className='card stats-card text-white'>
                                    <div className='card-body text-center'>
                                        <i className='fas fa-gavel fa-2x mb-2'></i>
                                        <h4>{totalLegal}</h4>
                                        <p>Orgs Legais</p>
                                    </div>
                                </div>
                            </div>
                            <div className='col-md-3'>
                                <div className='card stats-card text-white'>
                                    <div className='card-body text-center'>
                                        <i className='fas fa-skull-crossbones fa-2x mb-2'></i>
                                        <h4>{totalIlegal}</h4>
                                        <p>Orgs Ilegais</p>
                                    </div>
                                </div>
                            </div>
                            <div className='col-md-3'>
                                <div className='card stats-card text-white'>
                                    <div className='card-body text-center'>
                                        <i className='fas fa-users fa-2x mb-2'></i>
                                        <h4>{totalMembros}</h4>
                                        <p>Total de Membros</p>
                                    </div>
                                </div>
                            </div>
                            <div className='col-md-3'>
                                <div className='card stats-card text-white'>
                                    <div className='card-body text-center'>
                                        <i className='fas fa-cogs fa-2x mb-2'></i>
                                        <h4>{orgs.filter(org => org.tags_fabricacao && org.tags_fabricacao.length > 0).length}</h4>
                                        <p>Com Fabricação</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {showAdminPanel && user?.role === 'admin' && (
                            <div className='row mb-4'>
                                <div className='col-12'>
                                    <div className='card'>
                                        <div className='card-header bg-warning text-dark'>
                                            <h5 className='mb-0'>
                                                <i className='fas fa-user-shield me-2'></i>
                                                Painel de Administração
                                            </h5>
                                        </div>
                                        <div className='card-body'>
                                            <div className='row'>
                                                <div className='col-md-6'>
                                                    <h6 className='text-warning'>
                                                        <i className='fas fa-clock me-2'></i>
                                                        Usuários Pendentes ({pendingUsers.length})
                                                    </h6>
                                                    {pendingUsers.length > 0 ? (
                                                        <div className='list-group mb-3'>
                                                            {pendingUsers.map(user => (
                                                                <div key={user.id} className='list-group-item d-flex justify-content-between align-items-center'>
                                                                    <div>
                                                                        <strong>{user.username}</strong> - {user.email}
                                                                        <br />
                                                                        <small className='text-muted'>
                                                                            Criado em: {new Date(user.created_at).toLocaleDateString('pt-BR')}
                                                                        </small>
                                                                    </div>
                                                                    <div>
                                                                        <button
                                                                            className='btn btn-success btn-sm me-2'
                                                                            onClick={() => handleApproveUser(user.id, { status: 'aprovado', role: 'visualizador' })}
                                                                        >
                                                                            <i className='fas fa-check'></i> Aprovar
                                                                        </button>
                                                                        <button
                                                                            className='btn btn-danger btn-sm'
                                                                            onClick={() => handleApproveUser(user.id, { status: 'rejeitado' })}
                                                                        >
                                                                            <i className='fas fa-times'></i> Rejeitar
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <p className='text-muted'>Nenhum usuário pendente.</p>
                                                    )}
                                                </div>
                                                <div className='col-md-6'>
                                                    <h6 className='text-info'>
                                                        <i className='fas fa-users me-2'></i>
                                                        Todos os Usuários ({allUsers.length})
                                                    </h6>
                                                    <div className='mb-3'>
                                                        <select
                                                            className='form-select form-select-sm'
                                                            value={userFilter}
                                                            onChange={(e) => {
                                                                setUserFilter(e.target.value);
                                                                fetchAllUsers(localStorage.getItem('token'));
                                                            }}
                                                        >
                                                            <option value=''>Todos os status</option>
                                                            <option value='pendente'>Pendente</option>
                                                            <option value='aprovado'>Aprovado</option>
                                                            <option value='rejeitado'>Rejeitado</option>
                                                            <option value='suspenso'>Suspenso</option>
                                                        </select>
                                                    </div>
                                                    <div className='table-responsive' style={{maxHeight: '300px', overflowY: 'auto'}}>
                                                        <table className='table table-sm'>
                                                            <thead>
                                                                <tr>
                                                                    <th>Usuário</th>
                                                                    <th>Role</th>
                                                                    <th>Status</th>
                                                                    <th>Ações</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {allUsers.map(user => (
                                                                    <tr key={user.id}>
                                                                        <td>
                                                                            <strong>{user.username}</strong>
                                                                            <br />
                                                                            <small className='text-muted'>{user.email}</small>
                                                                        </td>
                                                                        <td>
                                                                            <select
                                                                                className='form-select form-select-sm'
                                                                                value={user.role}
                                                                                onChange={(e) => handleUpdateUser(user.id, { role: e.target.value })}
                                                                            >
                                                                                <option value='visualizador'>Visualizador</option>
                                                                                <option value='moderador_legal'>Moderador Legal</option>
                                                                                <option value='moderador_ilegal'>Moderador Ilegal</option>
                                                                                <option value='admin'>Admin</option>
                                                                            </select>
                                                                        </td>
                                                                        <td>
                                                                            <span className={`badge ${
                                                                                user.status === 'aprovado' ? 'bg-success' :
                                                                                user.status === 'pendente' ? 'bg-warning' :
                                                                                user.status === 'rejeitado' ? 'bg-danger' : 'bg-secondary'
                                                                            }`}>
                                                                                {user.status}
                                                                            </span>
                                                                        </td>
                                                                <td>
                                                                            <button
                                                                                className='btn btn-warning btn-sm me-1'
                                                                                onClick={() => handleChangePassword(user.id)}
                                                                                title='Trocar Senha'
                                                                            >
                                                                                <i className='fas fa-key'></i>
                                                                            </button>
                                                                            <button
                                                                                className={`btn btn-sm me-1 ${user.status === 'suspenso' ? 'btn-success' : 'btn-warning'}`}
                                                                                onClick={() => handleToggleBlockUser(user.id, user.status)}
                                                                                title={user.status === 'suspenso' ? 'Desbloquear' : 'Bloquear'}
                                                                            >
                                                                                <i className={`fas ${user.status === 'suspenso' ? 'fa-unlock' : 'fa-lock'}`}></i>
                                                                            </button>
                                                                            <button
                                                                                className='btn btn-danger btn-sm'
                                                                                onClick={() => handleDeleteUser(user.id)}
                                                                                disabled={user.role === 'admin'}
                                                                            >
                                                                                <i className='fas fa-trash'></i>
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className='row'>
                            <div className='col-md-8'>
                                <div className='card'>
                                    <div className='card-header d-flex justify-content-between align-items-center'>
                                        <h5 className='mb-0'>
                                            <i className='fas fa-list me-2'></i>
                                            Organizações ({filteredOrgs.length}{filteredOrgs.length !== orgs.length ? ` de ${orgs.length}` : ''})
                                        </h5>
                                        <div className='d-flex gap-2'>
                                            <div className='btn-group btn-group-sm' role='group'>
                                                <button
                                                    type='button'
                                                    className={`btn ${filterType === 'TODOS' ? 'btn-primary' : 'btn-outline-primary'}`}
                                                    onClick={() => handleFilterChange('TODOS')}
                                                >
                                                    Todos
                                                </button>
                                                <button
                                                    type='button'
                                                    className={`btn ${filterType === 'LEGAL' ? 'btn-success' : 'btn-outline-success'}`}
                                                    onClick={() => handleFilterChange('LEGAL')}
                                                >
                                                    Legais
                                                </button>
                                                <button
                                                    type='button'
                                                    className={`btn ${filterType === 'ILEGAL' ? 'btn-danger' : 'btn-outline-danger'}`}
                                                    onClick={() => handleFilterChange('ILEGAL')}
                                                >
                                                    Ilegais
                                                </button>
                                            </div>
                                            <button className='btn btn-success btn-sm' onClick={() => setShowModal(true)}>
                                                <i className='fas fa-plus me-1'></i>
                                                Nova Org
                                            </button>
                                            <button className='btn btn-info btn-sm' onClick={() => document.getElementById('csvFile').click()}>
                                                <i className='fas fa-upload me-1'></i>
                                                Importar CSV
                                            </button>
                                            <input
                                                type='file'
                                                id='csvFile'
                                                accept='.csv,.xlsx'
                                                style={{display: 'none'}}
                                                onChange={handleImport}
                                            />
                                        </div>
                                    </div>
                                    {selectedOrgs.length > 0 && (
                                        <div className='card-header bg-light'>
                                            <div className='d-flex justify-content-between align-items-center'>
                                                <span>{selectedOrgs.length} organização(ões) selecionada(s)</span>
                                                <button className='btn btn-danger btn-sm' onClick={handleBulkDelete}>
                                                    <i className='fas fa-trash me-1'></i>
                                                    Excluir Selecionadas
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                    <div className='card-body'>
                                        <div className='table-responsive'>
                                            <table className='table table-hover'>
                                                <thead className='table-dark'>
                                                    <tr>
                                                        <th style={{width: '40px'}}>
                                                            <input
                                                                type='checkbox'
                                                                checked={selectedOrgs.length === filteredOrgs.length && filteredOrgs.length > 0}
                                                                onChange={handleSelectAll}
                                                            />
                                                        </th>
                                                        <th>Facção</th>
                                                        <th>Tipo</th>
                                                        <th>Membros</th>
                                                        <th>Data Entrega</th>
                                                        <th>Fabricação</th>
                                                        <th>Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {filteredOrgs.map(org => (
                                                        <tr key={org.id}>
                                                            <td>
                                                                <input
                                                                    type='checkbox'
                                                                    checked={selectedOrgs.includes(org.id)}
                                                                    onChange={() => handleSelectOrg(org.id)}
                                                                />
                                                            </td>
                                                            <td>
                                                                {org.faccao}
                                                                {org.ativo === false && <span className='badge bg-secondary ms-1'>Inativo</span>}
                                                                {org.entregue && <span className='badge bg-success ms-1'>Entregue</span>}
                                                            </td>
                                                            <td>
                                                                <span className={`badge ${org.tipo === 'LEGAL' ? 'badge-legal' : 'badge-ilegal'}`}>
                                                                    {org.tipo}
                                                                </span>
                                                            </td>
                                                            <td>{org.membros_ativos || 0}</td>
                                                            <td>
                                                                {org.data_entrega ? new Date(org.data_entrega).toLocaleDateString('pt-BR') : '-'}
                                                            </td>
                                                            <td>
                                                                {org.tags_fabricacao && org.tags_fabricacao.length > 0 ? (
                                                                    <div>
                                                                        {org.tags_fabricacao.slice(0, 2).map((tag, index) => (
                                                                            <span key={index} className='badge bg-info me-1 mb-1'>
                                                                                {tag}
                                                                            </span>
                                                                        ))}
                                                                        {org.tags_fabricacao.length > 2 && (
                                                                            <span className='badge bg-light text-dark'>+{org.tags_fabricacao.length - 2}</span>
                                                                        )}
                                                                    </div>
                                                                ) : (
                                                                    <span className='text-muted'>Nenhuma</span>
                                                                )}
                                                            </td>
                                                            <td>
                                                                <button className='btn btn-sm btn-outline-primary me-1' onClick={() => handleEdit(org)}>
                                                                    <i className='fas fa-edit'></i>
                                                                </button>
                                                                <button className='btn btn-sm btn-outline-danger' onClick={() => handleDelete(org.id)}>
                                                                    <i className='fas fa-trash'></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className='col-md-4'>
                                <div className='card'>
                                    <div className='card-header'>
                                        <h5 className='mb-0'>
                                            <i className='fas fa-history me-2'></i>
                                            Últimas Ações
                                        </h5>
                                    </div>
                                    <div className='card-body' style={{maxHeight: '400px', overflowY: 'auto'}}>
                                        {auditLogs.map((log, index) => (
                                            <div key={index} className='mb-2 p-2 border rounded'>
                                                <small className='text-muted'>
                                                    {new Date(log.timestamp).toLocaleString('pt-BR')}
                                                </small>
                                                <div className='fw-bold'>{log.action.toUpperCase()}</div>
                                                <div className='small'>{log.details}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {showModal && (
                        <div className='modal show d-block' style={{backgroundColor: 'rgba(0,0,0,0.5)'}}>
                            <div className='modal-dialog'>
                                <div className='modal-content'>
                                    <div className='modal-header'>
                                        <h5 className='modal-title'>
                                            {editingOrg ? 'Editar Organização' : 'Nova Organização'}
                                        </h5>
                                        <button type='button' className='btn-close' onClick={() => setShowModal(false)}></button>
                                    </div>
                                    <form onSubmit={handleSubmit}>
                                        <div className='modal-body'>
                                            <div className='mb-3'>
                                                <label className='form-label'>Organização</label>
                                                <input
                                                    type='text'
                                                    className='form-control'
                                                    value={formData.faccao}
                                                    onChange={(e) => setFormData({...formData, faccao: e.target.value})}
                                                    required
                                                />
                                            </div>
                                            <div className='mb-3'>
                                                <label className='form-label'>Tipo *</label>
                                                <select
                                                    className='form-control'
                                                    value={formData.tipo}
                                                    onChange={(e) => setFormData({...formData, tipo: e.target.value})}
                                                    required
                                                >
                                                    <option value='LEGAL'>Legal</option>
                                                    <option value='ILEGAL'>Ilegal</option>
                                                </select>
                                            </div>
                                            <div className='mb-3'>
                                                <label className='form-label'>Membros Ativos</label>
                                                <input
                                                    type='number'
                                                    className='form-control'
                                                    value={formData.membros_ativos}
                                                    onChange={(e) => setFormData({...formData, membros_ativos: e.target.value})}
                                                />
                                            </div>
                                            <div className='mb-3'>
                                                <label className='form-label'>Tags de Fabricação</label>
                                                <div className='border rounded p-2' style={{minHeight: '100px'}}>
                                                    <div className='mb-2'>
                                                        <small className='text-muted'>Tags pré-definidas:</small>
                                                        <div className='d-flex flex-wrap gap-1 mt-1'>
                                                            {['Armas', 'Drogas', 'Veículos', 'Dinheiro', 'Documentos', 'Joias', 'Eletrônicos', 'Roupas', 'Comida', 'Bebidas'].map((tag) => (
                                                                <button
                                                                    key={tag}
                                                                    type='button'
                                                                    className={`btn btn-sm ${formData.tags_fabricacao.includes(tag) ? 'btn-success' : 'btn-outline-secondary'}`}
                                                                    onClick={() => {
                                                                        const newTags = formData.tags_fabricacao.includes(tag)
                                                                            ? formData.tags_fabricacao.filter(t => t !== tag)
                                                                            : [...formData.tags_fabricacao, tag];
                                                                        setFormData({...formData, tags_fabricacao: newTags});
                                                                    }}
                                                                >
                                                                    {tag}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <small className='text-muted'>Tags selecionadas:</small>
                                                        <div className='d-flex flex-wrap gap-1 mt-1'>
                                                            {formData.tags_fabricacao.map((tag, index) => (
                                                                <span key={index} className='badge bg-primary me-1 mb-1'>
                                                                    {tag}
                                                                    <button
                                                                        type='button'
                                                                        className='btn-close btn-close-white ms-1'
                                                                        style={{fontSize: '10px'}}
                                                                        onClick={() => {
                                                                            const newTags = formData.tags_fabricacao.filter((_, i) => i !== index);
                                                                            setFormData({...formData, tags_fabricacao: newTags});
                                                                        }}
                                                                    ></button>
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    <input
                                                        type='text'
                                                        className='form-control form-control-sm mt-2'
                                                        placeholder='Ou digite uma tag personalizada e pressione Enter'
                                                        onKeyPress={(e) => {
                                                            if (e.key === 'Enter') {
                                                                e.preventDefault();
                                                                const value = e.target.value.trim();
                                                                if (value && !formData.tags_fabricacao.includes(value)) {
                                                                    setFormData({
                                                                        ...formData,
                                                                        tags_fabricacao: [...formData.tags_fabricacao, value]
                                                                    });
                                                                }
                                                                e.target.value = '';
                                                            }
                                                        }}
                                                    />
                                                </div>
                                                <small className='text-muted'>Separe tags por vírgula ou barra (/) no CSV</small>
                                            </div>
                                            <div className='mb-3'>
                                                <label className='form-label'>Contato</label>
                                                <input
                                                    type='text'
                                                    className='form-control'
                                                    value={formData.contato}
                                                    onChange={(e) => setFormData({...formData, contato: e.target.value})}
                                                />
                                            </div>
                                            <div className='mb-3'>
                                                <label className='form-label'>Discord Líder</label>
                                                <input
                                                    type='text'
                                                    className='form-control'
                                                    value={formData.discord_lider}
                                                    onChange={(e) => setFormData({...formData, discord_lider: e.target.value})}
                                                />
                                            </div>
                                            <div className='mb-3'>
                                                <label className='form-label'>Data de Entrega</label>
                                                <input
                                                    type='date'
                                                    className='form-control'
                                                    value={formData.data_entrega}
                                                    onChange={(e) => setFormData({...formData, data_entrega: e.target.value})}
                                                />
                                            </div>
                                            <div className='mb-3'>
                                                <div className='form-check'>
                                                    <input
                                                        type='checkbox'
                                                        className='form-check-input'
                                                        id='ativo'
                                                        checked={formData.ativo}
                                                        onChange={(e) => setFormData({...formData, ativo: e.target.checked})}
                                                    />
                                                    <label className='form-check-label' htmlFor='ativo'>
                                                        Organização Ativa
                                                    </label>
                                                </div>
                                            </div>
                                            <div className='mb-3'>
                                                <div className='form-check'>
                                                    <input
                                                        type='checkbox'
                                                        className='form-check-input'
                                                        id='entregue'
                                                        checked={formData.entregue}
                                                        onChange={(e) => setFormData({...formData, entregue: e.target.checked})}
                                                    />
                                                    <label className='form-check-label' htmlFor='entregue'>
                                                        Produto Entregue
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div className='modal-footer'>
                                            <button type='button' className='btn btn-secondary' onClick={() => setShowModal(false)}>
                                                Cancelar
                                            </button>
                                            <button type='submit' className='btn btn-primary' disabled={loading}>
                                                {loading ? 'Salvando...' : (editingOrg ? 'Atualizar' : 'Criar')}
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
